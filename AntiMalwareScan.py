import os
import shutil
import psutil
import hashlib

def get_virus_signatures():
  virus_signatures = {}

  # Leer las firmas de virus de la base de datos
  with open("virus_signatures.txt", "r") as f:
    for line in f:
      virus_name, virus_signature = line.strip().split(":")
      virus_signatures[virus_name] = virus_signature

  return virus_signatures

def scan_processes():
  virus_signatures = get_virus_signatures()
  suspicious_processes = []

  # Obtener todos los procesos en ejecución
  for process in psutil.process_iter():
    try:
      # Obtener información del proceso
      process_info = process.as_dict(attrs=["name", "exe", "cmdline"])

      # Calcular la firma del proceso
      process_signature = hashlib.md5(process_info["exe"].encode()).hexdigest()

      # Revisar si la firma del proceso coincide con alguna de las firmas de virus de la base de datos
      for virus_name, virus_signature in virus_signatures.items():
        if process_signature == virus_signature:
          suspicious_processes.append((virus_name, process_info))
    except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
      pass

  return suspicious_processes

def scan_files(folder):
  virus_signatures = get_virus_signatures()
  quarantined_folder = "quarantine"
  extensions_to_check = [".exe", ".dll", ".msi"]

  # Crear la carpeta de cuarentena si no existe
  if not os.path.exists(quarantined_folder):
    os.makedirs(quarantined_folder)

  # Recorrer todos los archivos en la carpeta
  for root, dirs, files in os.walk(folder):
    for file in files:
      file_path = os.path.join(root, file)

      # Revisar si el archivo tiene una extensión sospechosa
      for extension in extensions_to_check:
        if file_path.endswith(extension):
          # Calcular la firma del archivo
          file_signature = hashlib.md5(open(file_path, "rb").read()).hexdigest()

          # Revisar si la firma del archivo coincide con alguna de las firmas de virus de la base de datos
          for virus_name, virus_signature in virus_signatures.items():
            if file_signature == virus_signature:
              # Mover el archivo a la carpeta de cuarentena
              shutil.move(file_path, quarantined_folder)
              print(f"Moved {file_path} to {quarantined_folder}")

def scan(folder, eliminate_virus=False):
  # Buscar archivos sospechosos
  scanned_files = scan_files(folder)

  # Buscar procesos sospechosos
  suspicious_processes = scan_processes()

  if eliminate_virus:
    eliminate_virus(scanned_files, suspicious_processes)
  else:
    # Mover los archivos y procesos sospechosos a la carpeta de cuarentena
    for file in scanned_files:
      shutil.move(file, quarantined_folder)
      print(f"Moved {file} to {quarantined_folder}")

    for virus_name, process in suspicious_processes:
      print(f"Found suspicious process: {process}")

def eliminate_virus(scanned_files, suspicious_processes):
  # Eliminar los archivos sospechosos
  for file in scanned_files:
    os.remove(file)
    print(f"Removed {file}")

  # Eliminar los procesos sospechosos
  for virus_name, process in suspicious_processes:
    process.kill()
    print(f"Killed suspicious process: {process}")

# Preguntar al usuario si desea eliminar los virus encontrados
response = input("Would you like to eliminate the found viruses? [y/n]")
if response.lower() == "y":
  eliminate_virus = True
else:
  eliminate_virus = False

# Probar el escaneo en la carpeta "downloads"
scan("downloads", eliminate_virus=eliminate_virus)